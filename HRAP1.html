<!DOCTYPE html>
<html lang = "en">
<head>
    <meta charset="utf-8">
    <title>HRAP
    </title>
    <script src="https://d3js.org/d3.v5.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/colorbrewer.v1.min.js"></script>

    <style type="text/css">
    #tooltip{
        position:absolute;
        width:150px;
        height:auto;
        padding:10px;
        background-color: white;
        border-radius:10px;
        box-shadow: 4px 4px 10px rgba(0,0,0,0.4);
        pointer-events: none;
    }

    #tooltip p{
        margin:0;
        font-family: sans-serif;
        font-size:12px;
    }
    #tooltip.hidden{
        display:none;
    }


    </style>

</head>

<body>
    <div style="width:1770px">
  <svg width="350" height="400" id="svg1" ></svg>
  <svg width="350" height="400" id="svg2" >></svg>
    </div>
    <div id="tooltip" class="hidden">
        <p>
            <b><i>HSA:</i></b> <span id="area"></span><br />
        </p>
    </div>

    <svg id="key1"></svg>
<script type="text/javascript">
// create an SVG region
const width = 350, height = 400;
const svgNeed = d3.select("#svg1")
				.append("svg")
				.attr("width", width)
				.attr("height", height)

const svgResource = d3.select("#svg2")
				.append("svg")
				.attr("width", width)
				.attr("height", height)



const color = d3.scaleSequential(d3.interpolateBuGn)

// Add a legend for the color values.
  var legend = svgNeed.selectAll("#key1")
      .data(color.ticks(6).slice(1).reverse())
    .enter().append("g")
      .attr("class", "legend")
      .attr("transform", function(d, i) { return "translate(" + (0) + "," + (20 + i * 20) + ")"; });

  legend.append("rect")
      .attr("width", 20)
      .attr("height", 20)
      .style("fill", color);

  legend.append("text")
      .attr("x", 26)
      .attr("y", 10)
      .attr("dy", ".35em")
      .text(String);

  svgNeed.append("text")
      .attr("class", "label")
      .attr("x", width + 20)
      .attr("y", 10)
      .attr("dy", ".35em")
      .text("Count");


// set-up unit projection and path
 var projection = d3.geoMercator()
     .translate([width, height])


// create a path tool that will translate GeoJSON into SVG path data
 var path = d3.geoPath()
     .projection(projection);

 // create our coloring tool
 // const color = d3.scaleQuantize()
 // .range(colorbrewer.YlGnBu[8].reverse());

   //.range(["#33FF6B", "#FF3333"]);

//TODO: add interaction to select metric
let metric="Developmental_Screening_Rate";


// fetch our data -- first the map, and then the CSV data (the order matters little here since we
// are not displaying anything until the binding is done)
Promise.all([
d3.json("hsa.geojson"),
d3.csv("HRAP_Data_Need.csv"),
d3.csv("HRAP_Data_Resource.csv")
]).then(function(data){
    console.log(data[0])
    console.log(data[1])
    console.log(data[2])
    const map_data = data[0];
    const hrap_data_need = data[1];
    const hrap_data_resource = data[2]

    const resourceDict = {"Developmental Screening": "Availability of Early Head Start*", "Abstain From Smoking During Pregnancy": "# of 802 Quits Partners",
                        "Breast Cancer Screening" : "# Ladies First Enrollees*", "Cervical Cancer Screening": "# Ladies First Enrollees*",
                    "Chlamydia Screening": "# Clinics that test for chlamydia", "Neonatal Abstinence Syndrome ": "# of Private Providers for Buprenorphine Treatment*"}

    var menu = d3.select("#metrics");
		for (prop in hrap_data_need[0]){
			if (prop != "HSA_NAME"){
				menu.append("option").attr("value",prop).text(prop);
			}
		}
    // set the behavior on a change to the menu (i.e., update the coloring)
    		d3.select("select").on("change", function () {
    			setNeedMetric(this.value)
                console.log(this.value)
                setResourceMetric(resourceDict[this.value])
    			});


    projection.fitExtent([[20, 20], [350, 400]], map_data);

    // set the domain for our color scale now that we have data
    color.domain(d3.extent(hrap_data_need, (d) => +d[metric]));

    // create a map of our hrap data, so we can easily find records
    // corresponding to a particular hsa
    const hsa_map_need = d3.map();
    hrap_data_need.forEach((d)=> {hsa_map_need.set(d["HSA_NAME"],d)})

    const hsa_map_resource = d3.map();
    hrap_data_resource.forEach((d)=> {hsa_map_resource.set(d["HSA_NAME"],d)})

    // loop through all of the path data, attaching the appropriate
    // record to each one based on the name
    for (let i = 0; i < map_data.features.length; i++){
        let name = map_data.features[i].properties["HSA_NAME"];
        map_data.features[i].properties.value = hsa_map_need.get(name);
        map_data.features[i].properties.value1 = hsa_map_resource.get(name);
    }

    console.log(map_data.features)

    // create the HSA's in the need SVG
    const serviceAreasNeed = svgNeed.selectAll("path")
        .data(map_data.features)
        .enter()
        .append("path")
        .attr("d", path)
        .attr("class","hsa")
        .style("stroke", "black")
        .style("stroke-width", "1px")

    serviceAreasNeed.on("mouseover", function(d){
        d3.select(this).classed("highlighted", true)
        d3.select("#tooltip").classed("hidden", false)
        d3.select("#area").text(d.properties.value.HSA_NAME)

        const coordinates = [d3.event.pageX, d3.event.pageY]
        const tooltip = d3.select("#tooltip")
        .style("left", (coordinates[0]+25)+"px")
        .style("top", (coordinates[1]+25)+"px");
    });

    serviceAreasNeed.on("mouseout", function(d){d3.select(this)
        .classed("highlighted", false)
        d3.select("#tooltip")
        .classed("hidden",true)});


    // create the HSA's in the resource SVG
    const serviceAreasResource = svgResource.selectAll("path")
        .data(map_data.features)
        .enter()
        .append("path")
        .attr("d", path)
        .attr("class","hsa")
        .style("stroke", "black")
        .style("stroke-width", "1px")

        serviceAreasResource.on("mouseover", function(d){
            d3.select(this).classed("highlighted", true)
            d3.select("#tooltip").classed("hidden", false)
            d3.select("#area").text(d.properties.value1.HSA_NAME)

            const coordinates = [d3.event.pageX, d3.event.pageY]
            const tooltip = d3.select("#tooltip")
            .style("left", (coordinates[0]+25)+"px")
            .style("top", (coordinates[1]+25)+"px");
        });

        serviceAreasResource.on("mouseout", function(d){d3.select(this)
            .classed("highlighted", false)
            d3.select("#tooltip")
            .classed("hidden",true)});



        function setNeedMetric(metric){
    			color.domain(d3.extent(hrap_data_need, (d) => +d[metric]));
                    serviceAreasNeed.transition()
				    .duration(1500)
                    .style("fill", function(d){
                        if (d.properties.value){
                            return color(+d.properties.value[metric]);
                        }	else{
                            return "red";
                        }

                    });


    		}
        function setResourceMetric(metric){
            console.log(metric)
                color.domain(d3.extent(hrap_data_resource, (d) => +d[metric]));
                    serviceAreasResource.transition()
                    .duration(1500)
                    .style("fill", function(d){
                        if (d.properties.value){
                            return color(+d.properties.value1[metric]);
                        }	else{
                            return "red";
                        }

                    });

            }
    setNeedMetric("Developmental Screening")
    setResourceMetric(resourceDict["Developmental Screening"])


});


</script>
<select><optgroup label="Metrics" id="metrics"></optgroup></select>

    </body>
</html>
